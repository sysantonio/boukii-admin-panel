<!-- Season Selection Modal -->
<vex-season-selector 
  *ngIf="showSeasonSelector"
  [availableSeasons]="availableSeasons"
  [showAsModal]="true"
  (seasonSelected)="onSeasonSelected($event)"
  (newSeasonCreated)="onNewSeasonCreated($event)"
  (cancelled)="onSeasonSelectorCancelled()"
></vex-season-selector>

<!-- Insufficient Permissions Screen -->
<app-insufficient-permissions
  *ngIf="!loading && hasSeasonAccess && !hasAnyPermissions && !showSeasonSelector"
  [title]="'Sin Permisos para esta Temporada'"
  [message]="'No tienes permisos suficientes para acceder a las funcionalidades de esta temporada.'"
  [suggestion]="'Contacta con tu administrador para obtener los permisos necesarios o selecciona una temporada diferente.'"
  [showBackButton]="false"
  [showContactSupport]="true"
></app-insufficient-permissions>

<div class="dashboard-container">
  <!-- Season Selection Required Message -->
  <div *ngIf="requiresSeasonSelection && !showSeasonSelector" class="season-required-message">
    <div class="message-card">
      <mat-icon class="message-icon">calendar_today</mat-icon>
      <h3>SelecciÃ³n de Temporada Requerida</h3>
      <p>Para acceder al dashboard, necesitas seleccionar una temporada de trabajo.</p>
      <button mat-raised-button color="primary" (click)="showSeasonSelector = true">
        Seleccionar Temporada
      </button>
    </div>
  </div>

  <!-- Dashboard Content (only show when season is selected) -->
  <div *ngIf="!requiresSeasonSelection || currentSeason">
    <!-- Hero Section with Gradient -->
    <div class="hero-section">
      <div class="hero-content">
        <div class="welcome-content">
          <h1 class="welcome-title">
            Â¡Bienvenido de vuelta, {{ currentUser?.name || 'Usuario' }}! ðŸ‘‹
          </h1>
          <p class="welcome-subtitle">
            Tienes {{ dashboardStats?.bookings?.todayCount || 0 }} nuevas reservas hoy y {{ dashboardStats?.courses?.active || 0 }} cursos programados para esta semana. 
            El rendimiento de tu escuela ha mejorado un {{ dashboardStats?.revenue?.growth || 0 }}% este mes.
          </p>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
          <button class="action-btn primary" (click)="navigateToRoute('/v5/bookings')">
            <mat-icon>event_note</mat-icon>
            Ver Reservas
          </button>
          <button class="action-btn secondary" (click)="navigateToRoute('/v5/bookings/new')">
            <mat-icon>add</mat-icon>
            Nueva Reserva
          </button>
          <button class="action-btn secondary" (click)="navigateToRoute('/v5/courses')">
            <mat-icon>school</mat-icon>
            Gestionar Cursos
          </button>
        </div>
        
        <!-- Status Indicators -->
        <div class="status-indicators">
          <div class="status-item">
            <mat-icon class="status-icon active">group</mat-icon>
            <span class="status-text">{{ monitorStats?.active || 0 }} monitores activos</span>
          </div>
          <div class="status-item">
            <mat-icon class="status-icon available">check_circle</mat-icon>
            <span class="status-text">{{ monitorStats?.available || 0 }} disponibles</span>
          </div>
          <div class="status-item">
            <mat-icon class="status-icon unavailable">block</mat-icon>
            <span class="status-text">{{ monitorStats?.onLeave || 0 }}h disponibles</span>
          </div>
        </div>
      </div>
      
      <!-- Weather Section -->
      <div class="weather-section" *ngIf="weatherData">
        <div class="weather-card">
          <div class="weather-main">
            <div class="temperature">{{ weatherData.temperature | number:'1.0-0' }}Â°</div>
            <div class="condition">{{ getWeatherConditionText(weatherData.condition) }}</div>
          </div>
          <div class="weather-details">
            <div class="weather-detail">
              <mat-icon>air</mat-icon>
              <span>{{ weatherData.windSpeed }} km/h</span>
              <span class="detail-label">Viento</span>
            </div>
            <div class="weather-detail">
              <mat-icon>visibility</mat-icon>
              <span>{{ weatherData.visibility }} km</span>
              <span class="detail-label">Visibilidad</span>
            </div>
            <div class="weather-detail">
              <mat-icon>opacity</mat-icon>
              <span>{{ weatherData.humidity }}%</span>
              <span class="detail-label">Humedad</span>
            </div>
            <div class="weather-detail">
              <mat-icon>ac_unit</mat-icon>
              <span>{{ weatherData.forecast?.[0]?.precipitationChance || 0 }}%</span>
              <span class="detail-label">Nieve prevista</span>
            </div>
          </div>
        </div>
        <div class="date-info">
          <span>{{ getTodayDate() }}</span>
        </div>
      </div>
    </div>
    
    <!-- Skier Illustration -->
    <div class="hero-illustration">
      <div class="skier-figure">
        <mat-icon class="skier-icon">downhill_skiing</mat-icon>
      </div>
    </div>
  </div>

  <!-- Stats Cards Row -->
  <div class="stats-row">
    <!-- Active Courses -->
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ dashboardStats?.courses?.active || 0 }}</div>
        <div class="stat-label">Cursos Activos</div>
        <div class="stat-change" [class.positive]="(dashboardStats?.courses?.occupancyRate || 0) > 70" [class.negative]="(dashboardStats?.courses?.occupancyRate || 0) <= 70">
          {{ dashboardStats?.courses?.occupancyRate || 0 }}% ocupaciÃ³n
        </div>
      </div>
      <div class="stat-icon private-courses">
        <mat-icon>person</mat-icon>
      </div>
    </div>

    <!-- Total Bookings -->
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ dashboardStats?.bookings?.total || 0 }}</div>
        <div class="stat-label">Total Reservas</div>
        <div class="stat-change" [class.positive]="(dashboardStats?.bookings?.weeklyGrowth || 0) > 0" [class.negative]="(dashboardStats?.bookings?.weeklyGrowth || 0) < 0">
          {{ formatPercentage(dashboardStats?.bookings?.weeklyGrowth || 0) }} semanal
        </div>
      </div>
      <div class="stat-icon group-courses">
        <mat-icon>groups</mat-icon>
      </div>
    </div>

    <!-- Confirmed Bookings -->
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ dashboardStats?.bookings?.confirmed || 0 }}</div>
        <div class="stat-label">Confirmadas</div>
        <div class="stat-change positive">{{ dashboardStats?.bookings?.pending || 0 }} pendientes</div>
      </div>
      <div class="stat-icon active-bookings">
        <mat-icon>event_available</mat-icon>
      </div>
    </div>

    <!-- Revenue Today -->
    <div class="stat-card">
      <div class="stat-content">
        <div class="stat-number">{{ formatCurrency(dashboardStats?.bookings?.todayRevenue || 0) }}</div>
        <div class="stat-label">Ingresos Hoy</div>
        <div class="stat-change" [class.positive]="(dashboardStats?.revenue?.growth || 0) > 0" [class.negative]="(dashboardStats?.revenue?.growth || 0) < 0">
          {{ formatPercentage(dashboardStats?.revenue?.growth || 0) }} mensual
        </div>
      </div>
      <div class="stat-icon daily-sales">
        <mat-icon>euro</mat-icon>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <!-- Sales by Channel Chart -->
    <div class="chart-card sales-chart">
      <div class="chart-header">
        <h3>Ventas por Canal</h3>
        <span class="chart-period">Ãšltimos 7 meses</span>
      </div>
      <div class="chart-content">
        <!-- Sales Channel Stats -->
        <div class="sales-stats" *ngIf="dashboardStats?.salesChannels">
          <div class="sales-totals">
            <div class="total-item" *ngFor="let channel of dashboardStats.salesChannels">
              <div class="total-label">{{ channel.channel }}</div>
              <div class="total-amount" [class.green]="channel.growth > 0" [class.red]="channel.growth < 0">
                {{ formatCurrency(channel.revenue) }}
              </div>
              <div class="total-change" [class.green]="channel.growth > 0" [class.red]="channel.growth < 0">
                {{ formatPercentage(channel.growth) }} del total
              </div>
            </div>
          </div>
        </div>
        <!-- Placeholder for chart -->
        <div class="chart-placeholder">
          <div class="chart-area">
            <svg viewBox="0 0 400 200" class="chart-svg">
              <!-- Grid lines -->
              <defs>
                <pattern id="grid" width="40" height="25" patternUnits="userSpaceOnUse">
                  <path d="M 40 0 L 0 0 0 25" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                </pattern>
              </defs>
              <rect width="100%" height="100%" fill="url(#grid)" />
              
              <!-- Chart lines -->
              <path d="M 20 150 Q 80 140 120 120 T 200 100 T 280 80 T 360 70" 
                    fill="none" stroke="#8b5cf6" stroke-width="2" stroke-dasharray="5,5"/>
              <path d="M 20 180 Q 80 170 120 160 T 200 150 T 280 140 T 360 130" 
                    fill="none" stroke="#06b6d4" stroke-width="2"/>
              <path d="M 20 120 Q 80 110 120 100 T 200 90 T 280 85 T 360 80" 
                    fill="none" stroke="#10b981" stroke-width="3"/>
              
              <!-- Area fill for main line -->
              <path d="M 20 120 Q 80 110 120 100 T 200 90 T 280 85 T 360 80 L 360 200 L 20 200 Z" 
                    fill="url(#gradient)" opacity="0.2"/>
              
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" style="stop-color:#10b981;stop-opacity:0.3" />
                  <stop offset="100%" style="stop-color:#10b981;stop-opacity:0" />
                </linearGradient>
              </defs>
              
              <!-- Data points -->
              <circle cx="120" cy="100" r="3" fill="#10b981"/>
              <circle cx="200" cy="90" r="3" fill="#10b981"/>
              <circle cx="280" cy="85" r="3" fill="#10b981"/>
              <circle cx="360" cy="80" r="3" fill="#10b981"/>
            </svg>
          </div>
          
          <!-- Legend -->
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-color objective"></div>
              <span>Objetivo</span>
            </div>
            <div class="legend-item">
              <div class="legend-color admin"></div>
              <span>Ventas Admin</span>
            </div>
            <div class="legend-item">
              <div class="legend-color online"></div>
              <span>Ventas Online</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Sessions Chart -->
    <div class="chart-card sessions-chart">
      <div class="chart-header">
        <h3>Sesiones Diarias</h3>
        <span class="chart-period">Esta semana</span>
      </div>
      <div class="chart-content">
        <!-- Bar chart placeholder -->
        <div class="bar-chart" *ngIf="recentSessions.length > 0; else noSessionsData">
          <div class="bar-item" *ngFor="let session of recentSessions; let i = index">
            <div class="bar-container">
              <div class="bar morning" [style.height.%]="(session.morningSlots / 30) * 100"></div>
              <div class="bar afternoon" [style.height.%]="(session.afternoonSlots / 30) * 100"></div>
            </div>
            <div class="bar-label">{{ getDayName(i) }}</div>
          </div>
        </div>
        
        <ng-template #noSessionsData>
          <div class="no-data-message" style="text-align: center; padding: 40px; color: #666;">
            <mat-icon style="font-size: 48px; margin-bottom: 16px;">bar_chart</mat-icon>
            <p>No hay datos de sesiones disponibles</p>
            <small *ngIf="loadingStats">Cargando datos...</small>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Today's Reservations -->
  <div class="reservations-section">
    <div class="reservations-header">
      <h3>
        <mat-icon>event</mat-icon>
        Reservas de Hoy
      </h3>
      <div class="reservations-summary">
        {{ dashboardStats?.todayReservations?.length || 0 }} confirmadas, {{ dashboardStats?.bookings?.pending || 0 }} pendientes â€¢ {{ getTodayDate() }}
      </div>
      <button class="agenda-btn">
        <mat-icon>calendar_month</mat-icon>
        Agenda Completa
      </button>
    </div>

    <!-- Reservations Table -->
    <div class="reservations-table" *ngIf="displayReservations.length > 0; else noReservationsData">
      <div class="table-header">
        <div class="col-id">ID</div>
        <div class="col-type">Tipo</div>
        <div class="col-course">Curso</div>
        <div class="col-client">Cliente</div>
        <div class="col-instructor">Instructor</div>
        <div class="col-time">Hora</div>
        <div class="col-status">Estado</div>
        <div class="col-price">Precio</div>
        <div class="col-actions"></div>
      </div>

      <div class="table-body">
        <div class="table-row" *ngFor="let reservation of displayReservations; let i = index">
          <div class="col-id">{{ reservation.id }}</div>
          <div class="col-type">
            <span class="course-type" [class]="getReservationTypeClass(reservation.courseType)">
              {{ getReservationTypeLabel(reservation.courseType) }}
            </span>
          </div>
          <div class="col-course">{{ reservation.courseType }}</div>
          <div class="col-client">
            <div class="client-info">
              <div class="client-avatar">{{ getClientInitials(reservation.clientName) }}</div>
              <div class="client-details">
                <div class="client-name">{{ reservation.clientName }}</div>
                <div class="client-email">{{ getClientEmail(reservation.clientName) }}</div>
              </div>
            </div>
          </div>
          <div class="col-instructor">{{ reservation.monitorName || 'Sin asignar' }}</div>
          <div class="col-time">
            <mat-icon class="time-icon">schedule</mat-icon>
            {{ reservation.startTime }}
          </div>
          <div class="col-status">
            <span class="status-badge" [class]="reservation.status">
              {{ getStatusLabel(reservation.status) }}
            </span>
          </div>
          <div class="col-price">â‚¬{{ getReservationPrice(reservation.courseType) }}</div>
          <div class="col-actions">
            <button class="action-btn-small">
              <mat-icon>more_horiz</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noReservationsData>
      <div class="no-data-message" style="text-align: center; padding: 40px; color: #666;">
        <mat-icon style="font-size: 48px; margin-bottom: 16px;">event_note</mat-icon>
        <p>No hay reservas programadas para hoy</p>
        <small *ngIf="loadingStats">Cargando reservas...</small>
      </div>
    </ng-template>
  </div>

  </div> <!-- End Dashboard Content -->

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando dashboard...</p>
  </div>
</div>